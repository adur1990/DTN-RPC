# Makefile.in for Serval DNA
# vim: noet ts=8 sts=0 sw=8
prefix=@prefix@
sysconfdir=@sysconfdir@

include sourcefiles.mk

CC= @CC@

LDFLAGS = -L. -lservalrpc @LDFLAGS@ @LIBS@

CFLAGS = @CPPFLAGS@ @CFLAGS@
# Include search paths
CFLAGS += -Iserval/general -Iserval/sqlite-amalgamation-3100200 -Iserval/nacl
# sysconfdir definition
CFLAGS += -DSYSCONFDIR="\"$(sysconfdir)\""
# Optimisation, position indipendent code, security check for functions like printf, and make it impossible to compile potential vulnerable code.
# Also add security checks for functions like memcpy, strcpy, etc.
CFLAGS += -O3 -fPIC -Wformat -Werror=format-security -D_FORTIFY_SOURCE=2
# SQLite (disable data functions, disable interactive compiling, no deprecated functions, disable extension loading functions, no virtual tables, no authorization)
CFLAGS += -DSQLITE_THREADSAFE=0 -DSQLITE_OMIT_DATETIME_FUNCS -DSQLITE_OMIT_COMPILEOPTION_DIAGS -DSQLITE_OMIT_DEPRECATED -DSQLITE_OMIT_LOAD_EXTENSION -DSQLITE_OMIT_VIRTUALTABLE -DSQLITE_OMIT_AUTHORIZATION
# Enable some functions defined in POSIX 600 standard and definitions normally not available or deprecated in macOS (i.e bzero).
CFLAGS += -D_XOPEN_SOURCE=600 -D_DARWIN_C_SOURCE
# Enable all and even more warnings, treat them as errors and show all errors.
CFLAGS += -Wall -Wextra -Werror -ferror-limit=0
# Some additional definitions, to not include headers for things like bzero or poll, ...
DEFS = @DEFS@

all:	servalrpc

.PRECIOUS: Makefile
Makefile: Makefile.in config.status
	$(warning Makefile may be out of date, please run ./config.status)

config.status: configure
	$(warning config.status may be out of date, please run ./configure)

configure: configure.ac
	$(warning configure may be out of date, please run autoreconf -f -i -I m4)

servalrpc: $(SRCS)
	@$(CC) -o $@ $^ $(CFLAGS) $(DEFS) $(LDFLAGS)

clean:
	@$(RM) -r servalrpc
